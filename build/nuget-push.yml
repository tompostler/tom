schedules:
- cron: 0 0 * * *
  displayName: Nightly NuGet Rollup
  branches:
    include:
    - main

# Not including the none trigger results in the default of "include *"
trigger: none

resources:
  pipelines:
  - pipeline: tci
    source: tom
    branch: main

name: '$(Date:%y).$(DayOfYear).$(Rev:r)'

pool:
  vmImage: windows-latest

variables:
- group: tompostler

steps:

- checkout: none

- powershell: |
    Write-Host "##vso[Build.UpdateBuildNumber]$(resources.pipeline.tci.runName) ($(Build.BuildNumber))"
  displayName: Update build number from source build

- download: tci
  artifact: drop
  displayName: Download build drop

- task: NuGetCommand@2
  displayName: NuGet push
  inputs:
    command: push
    packagesToPush: $(Agent.BuildDirectory)\tci\drop\*.nupkg
    nuGetFeedType: external
    publishFeedCredentials: f3d8b226-1860-4e09-81b1-d0a4d3ffcb6f

- powershell: |
    $body = @{
      BuildNumber = '$(Build.BuildNumber)';
    } | ConvertTo-Json;
    Invoke-WebRequest -Uri '$(logicappuri-unlimitedinf-update-version-file)' -Method POST -ContentType 'application/json' -Body $body -UseBasicParsing;
  displayName: Update Version file
